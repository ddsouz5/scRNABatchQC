---
title: "QC for single cell RNA-seq data"
output: 
  rmdformats::material:
    self_contained: false
    thumbnails: true
    lightbox: true
    gallery: true
    highlight: tango  
params:
  data: plotData
---

```{r setup, include=FALSE}
library(RColorBrewer)
library(knitr)
library(reshape2)
library(ggplot2)
library(data.table)
library(DT)
library(RCurl)
library(htmltools)

knitr::opts_chunk$set(echo = FALSE)

addLinkTag<-function(text,link) {
  result<-paste0("<a href='",link,"' target='_blank'>",text,"</a>")
  return(result)
}

figRef <- local({
  tag <- numeric()
  created <- logical()
  used <- logical()
  function(label, caption, prefix = options("figcap.prefix"), 
           sep = options("figcap.sep"), prefix.highlight = options("figcap.prefix.highlight")) {
    i <- which(names(tag) == label)
    if (length(i) == 0) {
      i <- length(tag) + 1
      tag <<- c(tag, i)
      names(tag)[length(tag)] <<- label
      used <<- c(used, FALSE)
      names(used)[length(used)] <<- label
      created <<- c(created, FALSE)
      names(created)[length(created)] <<- label
    }
    if (!missing(caption)) {
      created[label] <<- TRUE
      paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
             " ", caption)
    } else {
      used[label] <<- TRUE
      paste(prefix, tag[label])
    }
  }
})
options(figcap.prefix = "Figure", figcap.sep = ":", figcap.prefix.highlight = "**")

tabRef <- local({
  tag <- numeric()
  created <- logical()
  used <- logical()
  function(label, caption, prefix = options("tabcap.prefix"), 
           sep = options("tabcap.sep"), prefix.highlight = options("tabcap.prefix.highlight")) {
    i <- which(names(tag) == label)
    if (length(i) == 0) {
      i <- length(tag) + 1
      tag <<- c(tag, i)
      names(tag)[length(tag)] <<- label
      used <<- c(used, FALSE)
      names(used)[length(used)] <<- label
      created <<- c(created, FALSE)
      names(created)[length(created)] <<- label
    }
    if (!missing(caption)) {
      created[label] <<- TRUE
      paste0(prefix.highlight, prefix, " ", i, sep, prefix.highlight, 
             " ", caption)
    } else {
      used[label] <<- TRUE
      paste(prefix, tag[label])
    }
  }
})
options(tabcap.prefix = "Table", tabcap.sep = ":", tabcap.prefix.highlight = "**")
```

```{r data, include=FALSE, cache=FALSE}
plotData<-params$data
sces <- plotData$sces
scesall <- plotData$scesall
diffFC <- plotData$diffFC
hvgPathways<-plotData$hvgPathways
pc1Pathways<-plotData$pc1Pathways

if(length(sces) < 9){
  scolors=brewer.pal(length(sces), "Set1")
}else{
  scolors=rainbow(length(sces))
}
names(scolors)<-names(sces)

hasSimilarity<-length(sces) > 1
hasDifference<-length(sces) > 2

heatmapKeysize<-1
heatmapColors<-bluered(75)

```

# 1. Technical features

```{r dis_total_counts, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.align="center", fig.cap=figRef("density_total_counts", "Total count distribution"), fig.height=4}
print(plotDensity(sces,"total_counts", "Total count", scolors))
```


```{r sampleSimilarity, results="asis", echo=FALSE}
if(hasSimilarity){
  cat("# 2. Sample expression similarity")
}
```

```{r samplesimilarity, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.align="center", warning=FALSE, fig.cap=figRef("samplesimilarity", "Sample Similarity")}
if(hasSimilarity){
  plotSampleSimilarity(sces)
}
```

```{r biologicalSimilarity, results="asis", echo=FALSE}
if(hasSimilarity){
  cat("# 3. Biological Features similarity")
}
```

```{r biologicalSimilarityHVGenes, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.align="center", fig.cap=figRef("biologicalSimilarityHVGenes", "Top 50 highly variable genes with FDR < 0.01"), fig.height=10}
if(hasSimilarity){
  plotBiologicalSimilarity(sces, objectName="hvg", filterName="FDR", valueName="bio", cexRow = 0.5, cexCol = 0.5, keysize=heatmapKeysize, col=heatmapColors)
}
```

```{r pairwiseDifference, results="asis", echo=FALSE}
if(hasDifference){
  cat("# 4. Pairwise difference")
}
```

```{r tableDiffGenes, echo=FALSE, results="asis"}
if(hasDifference){
  kable(diffFC$genes, caption=tabRef("tableDiffGenes", "Differentially Expressed Genes"))
}
```

```{r plotDiffGenes, echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.align="center", fig.cap=figRef("plotDiffGenes", "Differentially Expressed Genes"), fig.height=8}
if(hasDifference){
  heatmap.2(as.matrix(diffFC$genes), cexRow = 0.6, cexCol = 0.6, margins = c(5, 10), keysize=heatmapKeysize, col=heatmapColors)
}
```
